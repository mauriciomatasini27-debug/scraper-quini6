name: Quini 6 Scraper AutomÃ¡tico

on:
  # Ejecutar los miÃ©rcoles y domingos a las 21:00 hora Argentina (ARG)
  # Argentina estÃ¡ en UTC-3, asÃ­ que 21:00 ARG = 00:00 UTC (del dÃ­a siguiente)
  # Para ejecutar el miÃ©rcoles a las 21:00 ARG, usamos jueves 00:00 UTC
  # Para ejecutar el domingo a las 21:00 ARG, usamos lunes 00:00 UTC
  schedule:
    # MiÃ©rcoles 21:00 ARG = Jueves 00:00 UTC (1.5 horas despuÃ©s del sorteo a las 19:30)
    - cron: '0 0 * * 4'  # Jueves 00:00 UTC = MiÃ©rcoles 21:00 ARG
    # Domingo 21:00 ARG = Lunes 00:00 UTC
    - cron: '0 0 * * 1'  # Lunes 00:00 UTC = Domingo 21:00 ARG
  
  # Permitir ejecuciÃ³n manual desde GitHub Actions
  workflow_dispatch:
    inputs:
      year:
        description: 'AÃ±o a procesar (dejar vacÃ­o para aÃ±o actual)'
        required: false
        type: string

jobs:
  scrape-quini6:
    name: Extraer Resultados Quini 6
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4

      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: ðŸ“¦ Instalar dependencias
        run: npm ci

      - name: ðŸŽ­ Instalar Playwright
        run: npx playwright install --with-deps chromium

      - name: ðŸ” Configurar variables de entorno
        env:
          CRAWLBASE_JS_TOKEN: ${{ secrets.CRAWLBASE_JS_TOKEN }}
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
        run: |
          echo "Variables de entorno configuradas"
          if [ -n "$CRAWLBASE_JS_TOKEN" ]; then
            echo "Crawlbase token configurado"
          fi
          if [ -n "$SUPABASE_URL" ]; then
            echo "Supabase URL configurada"
          fi

      - name: ðŸ—ï¸ Compilar TypeScript
        run: npm run build

      - name: ðŸŽ¯ Ejecutar Scraper
        env:
          CRAWLBASE_JS_TOKEN: ${{ secrets.CRAWLBASE_JS_TOKEN }}
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
          YEAR: ${{ github.event.inputs.year || '' }}
        run: |
          if [ -n "$YEAR" ]; then
            echo "Ejecutando scraper para el aÃ±o $YEAR"
            node dist/index.js $YEAR
          else
            echo "Ejecutando scraper para el aÃ±o actual"
            node dist/index.js
          fi

      - name: ðŸ“¤ Subir resultados a artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: resultados-quini6-${{ github.run_number }}
          path: data/*.json
          retention-days: 90

      - name: ðŸ“Š Resumen de resultados
        if: always()
        run: |
          echo "## ðŸ“Š Resultados del Scraping" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Fecha de ejecuciÃ³n:** $(date)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -d "data" ] && [ "$(ls -A data/*.json 2>/dev/null)" ]; then
            echo "### ðŸ“ Archivos generados:" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            ls -lh data/*.json | awk '{print $9 " - " $5}' >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ No se generaron archivos nuevos" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Workflow completado exitosamente" >> $GITHUB_STEP_SUMMARY

